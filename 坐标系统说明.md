# 八邻域边界追踪 - 坐标系统速查手册

## 一、坐标系统基础

### 图像坐标系

```
     0   col  187
   0 ┌──────────→ x轴
row  │
     │    图像
     ↓
     y轴
   119

• 原点: 左上角 (0, 0)
• x轴: 向右为正 (0→187)
• y轴: 向下为正 (0→119) ⚠️
• 尺寸: w188×h120
```


---

## 二、方向编码核心

### 2.1 +1偏移原理

**边界检测逻辑**:
```c
if (image[i位置] == 黑 && image[i+1位置] == 白) {
    选择坐标 = i+1位置;  // 实际移动到白色点
    记录方向 = i;        // 但记录的是黑色方向
}
```

**核心公式**: `实际方向 = seeds[(记录值 + 1) & 7]`

### 2.2 seeds数组定义

```c
// 左线 (顺时针)          // 右线 (逆时针)
seeds_l[8][2] = {         seeds_r[8][2] = {
  {0,  1},  // [0] 向下     {0,  1},  // [0] 向下
  {-1, 1},  // [1] 左下     {1,  1},  // [1] 右下
  {-1, 0},  // [2] 向左     {1,  0},  // [2] 向右
  {-1,-1},  // [3] 左上     {1, -1},  // [3] 右上
  {0, -1},  // [4] 向上★    {0, -1},  // [4] 向上★
  {1, -1},  // [5] 右上     {-1,-1},  // [5] 左上
  {1,  0},  // [6] 向右     {-1, 0},  // [6] 向左
  {1,  1}   // [7] 右下     {-1, 1}   // [7] 左下
};
```

### 2.3 方向图示

```
左线(顺时针):        右线(逆时针):
   3   4   5           5   4   3
   ╲  ↑  ╱             ╲  ↑  ╱
2 ←─ ● ─→ 6         6 ←─ ● ─→ 2
   ╱  ↓  ╲             ╱  ↓  ╲
   1   0   7           7   0   1
```

### 2.4 方向映射对照表 ★核心★

#### 左线方向映射

| 记录值 | 检测方向 | 实际生长 | 坐标偏移 | 使用场景 |
|:-----:|:-------:|:-------:|:--------:|:------:|
| 0 | 向下 | 左下 | {-1, 1} | 罕见 |
| 1 | 左下 | 向左 | {-1, 0} | 左弯 |
| 2 | 向左 | 左上 | {-1,-1} | 左弯 |
| **3** | **左上** | **向上** | **{0,-1}** | **主方向** |
| **4** | **向上** | **右上** | **{1,-1}** | **右弯** |
| **5** | **右上** | **向右** | **{1, 0}** | **右弯** |
| 6 | 向右 | 右下 | {1, 1} | 少见 |
| 7 | 右下 | 向下 | {0, 1} | 异常 |

#### 右线方向映射

| 记录值 | 检测方向 | 实际生长 | 坐标偏移 | 使用场景 |
|:-----:|:-------:|:-------:|:--------:|:------:|
| 0 | 向下 | 右下 | {1, 1} | 罕见 |
| 1 | 右下 | 向右 | {1, 0} | 右弯 |
| 2 | 向右 | 右上 | {1,-1} | 右弯 |
| **3** | **右上** | **向上** | **{0,-1}** | **主方向** |
| **4** | **向上** | **左上** | **{-1,-1}** | **左弯** |
| **5** | **左上** | **向左** | **{-1, 0}** | **左弯** |
| 6 | 向左 | 左下 | {-1, 1} | 少见 |
| 7 | 左下 | 向下 | {0, 1} | 异常 |


---

## 三、数据速查

### 3.1 核心数组

| 数组 | 类型 | 索引0含义 | 索引增长 | 用途 |
|:----:|:----:|:--------:|:-------:|:----:|
| `dir_l[120]` | uint8_t | 第1个追踪点(大致在图像底部) | 追踪顺序 | 方向序列(0-7) |
| `points_l[120][2]` | uint16_t | 第1个追踪点(大致在图像底部) | 追踪顺序 | 追踪坐标{x,y} |
| `l_border[120]` | uint8_t | 图像y=119行 | 图像行号 | 每行左边界x |
| `r_border[120]` | uint8_t | 图像y=119行 | 图像行号 | 每行右边界x |
| `left_lost[120]` | uint8_t | 图像y=119行 | 图像行号 | 左边界丢失标志 |
| `right_lost[120]` | uint8_t | 图像y=119行 | 图像行号 | 右边界丢失标志 |
| `center_line[120]` | uint8_t | 图像y=119行 | 图像行号 | 每行中线x |




### 3.3 坐标转换详解

#### 从points到border的转换过程

**代码逻辑**：
```c
void get_left(uint16_t total_L) {
    // 遍历所有追踪点
    for (j = 0; j < total_L; j++) {
        uint16_t row = image_h - 1 - points_l[j][1];  // ⚠️关键：反转y坐标
        uint16_t col = points_l[j][0];
        
        l_border[row] = col;        // 将x值存到对应行
        left_lost[row] = 0;         // 清除该行的丢线标志
    }
}
```


### 3.4 可视化对比

```
图像坐标系 vs 数组索引的关系：

图像(数组坐标)          points数组           l_border数组
                      (追踪顺序)           (图像行号反转)

y=0   顶部 ┐                              l_border[119]
y=1        │                              l_border[118]
...        │                              ...
y=60       │         points_l[50]         l_border[59]
...        │         points_l[3]          ...
y=115      │         points_l[2]          l_border[4]
y=116      │         points_l[1]          l_border[3]
y=117 起点 │         points_l[0]          l_border[2] 
y=118      │                              l_border[1]
y=119 底部 ┘                              l_border[0]

追踪方向：↑(从下往上)   索引：0→max         索引：对应y反转值
```


---



---

## 五、核心要点

1. **坐标系**: y轴向下为正，起点在底部(y≈117)
2. **+1偏移**: 记录i，实际i+1 (检测黑，选择白)
3. **主方向**: 记录3 = 实际向上 (最常见80%+)
4. **索引含义**: points按追踪顺序，border按图像行号(反转)
5. **丢线数组**: left_lost/right_lost标记边界丢失状态

---

**版本**: v3.0 | **日期**: 2025-10-25 
